<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

<h1><U>Cluster</U></h1>
<div class="basic-information">
  <h2><U>Health</U>:
    <% if @stats_hash["routing"]["lost_vnodes"].chomp != "0" %>
      <div class="health-button red large_size" style="display: inline-block;">
        <span class="glare red large"></span>
      </div>
    <% elsif @stats_hash["routing"]["short_vnodes"].chomp !="0" %>
      <div class="health-button yellow large_size" style="display: inline-block;">
        <span class="glare large"></span>
      </div>
    <% else %>
      <div class="health-button green large_size" style="display: inline-block;">
        <span class="glare large"></span>
      </div>
    <% end %>

    <button class="btn btn-warning" data-toggle="modal" data-target="#myModal" <%= can_i_recover?(@stats_hash, @routing_info) %>>
      Recover
    </button>

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Do you want to run Recover?</h4>
          </div>
          <div class="modal-recover-body">
            <ul>
              <li>This function updates routing file with surviving instance.
                <ul class="modal-explanation-detail">
                  <li>inactice instance will be removed from routing file. </li>
                  <li>After recovering, you can't use inactive instance without join as a new instance or modify routing directory.</li>
                </ul>
              </li>
            </ul>
          </div>
          <div class="modal-footer">
            <form action="update" method="get" style="display:inline">
              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Run Recover</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </h2>

  <div class="basic-columns"> 
    <table class="flat-panel">
      <tr>
        <td class="panel-instance">
          instance count
          <div class="panel-value">
            <%= @stats_hash["routing"]["nodes.length"] %><br>
              <div class="error-instance-small">
                <% @inactive_routing_list.each{|instance| %><li> <%= instance %> is down</li><% } %>
              </div>
          </div>
        </td>
    
        <td class="panel-server">
          server count
          <div class="panel-value">
            <%= get_server_list %>
          </div>
        </td>
    
        <td class="panel-roma-version">
          ROMA version
          <div class="panel-value">
            <%= @stats_hash["others"]["version"] %>
            <div class ="error-instance-small">
              <% @routing_info.each do |instance, info| %>
                <% if chk_main_version(info["version"]) %>
                  <li><%= "#{instance} using #{info["version"]}" %></li><br>
                <% end %>
              <% end %>
            </div>
 
          </div>
        </td>
      </tr>
    
      <tr>
        <% if short_vnodes?(@stats_hash) %>
          <td class="panel-short-vnodes-error">
            short vnodes
            <div class="panel-value" style="color :red;" id ="short_vnodes_cnt">
                <%= @stats_hash["routing"]["short_vnodes"] %>
            </div>
          </td>

        <% else %>
          <td class="panel-short-vnodes">
            short vnodes
            <div class="panel-value">
              <%= @stats_hash["routing"]["short_vnodes"] %>
            </div>
          </td>
        <% end %>

    
        <% if @stats_hash["routing"]["lost_vnodes"].chomp == "0" %>
          <td class="panel-lost-vnodes">
        <% else %>
          <td class="panel-lost-vnodes" style="background-color: #c13500">
        <% end %>
          lost vnodes
          <div class="panel-value">
            <%= @stats_hash["routing"]["lost_vnodes"] %>
          </div>
        </td>
    
        <td class="panel-gladiator-version">
          Gladiator version
          <div class="panel-value">
            <%= Constants::VERSION %>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <% if extra_process_chk(@routing_info) %>
    <div class="extra-process" id="extra-process">
      <h3><U>Executing process</U></h3>
      <div class="extra-pbar">
        <li><%= extra_process_chk(@routing_info) %> is being executed</li>
        <div class="progress progress-striped active">
          <div id="extra-progress-bar" class="progress-bar progress-bar-success"  role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
            <span id="extra-bar-rate">[ToDO]% Complete</span>
          </div>
        </div>
      </div>
    </div>
  <% end %>

</div>


<div class="instances-information">
  <button class="reset-filter btn btn-primary">Reset Filter</button>
  <div class="instance-table">
    <table class="table table-bordered result-table tablesorter">
      <thead>
        <tr>
          <th>No.</th>
          <th>Cluster Name</th>
          <th class="filter-select" data-placeholder="">Status</th>
          <th>Data rate</th>
          <th>Data size</th>
          <!--th>&nbsp;</th-->
        </tr>
      </thead>
      <tbody>
        <% 
        index = 0
        @routing_info.each do |(instance, info)|
          if info["status"] == "active" %>
            <tr>
          <% elsif info["status"] == "inactive" %>
            <tr class="active">
          <% elsif info["status"] =~ /recover|join/ %>
            <tr class="warning">
          <% end %>

            <td><%= index += 1 %></td>

            <td style="text-align: left"><%= instance %></td>

            <td style="text-align: left" class="instance-status-column">
              <% if info["status"] == "active" %>
                <div class="health-button green small_size" style="display: inline-block;"></div>
                <%= info["status"] %>
              <% elsif info["status"] == "inactive" %>
                <div class="health-button grey small_size" style="display: inline-block;"></div>
                <%= info["status"] %>
              <% else %>
                <div class="health-button yellow small_size" style="display: inline-block;"></div>
                <%= info["status"] %>
              <% end %>
            </td>

            <td class="progress-bar-column">
              <% if is_active?(info["status"]) %>
                <div class="progress progress-striped active" >
                  <span class="progress-bar"  role="progressbar" aria-valuenow="<%= current_size_rate(info["size"]) %>" aria-valuemin="0" aria-valuemax="100" style="width: <%= current_size_rate(info["size"]) %>%">
                     <%= current_size_rate(info["size"]) %> %
                  </span>
                </div>
              <% end %>
            </td>

            <td>
              <%if is_active?(info["status"]) %><%= instance_size(info["size"]) %> MB<% end %>
            </td>

<% if false %>
            <td>
              <form action="update" method="get" style="display:inline">
                <button type="submit" class="btn btn-warning" <%= opt_recover(info["status"], extra_process_chk(@routing_info)) %>>Recover</button>
              </form>
            </td>
<% end %>
          <tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
