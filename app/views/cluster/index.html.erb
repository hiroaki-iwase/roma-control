<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

<%= render 'cluster/modal' %>

<h1 class="contents-name"><U>Cluster</U></h1>
<div class="basic-information">
  <h2 class="sub-contents-name"><U>Health</U>:
    <% if @stats_hash["routing"]["lost_vnodes"].chomp != "0" %>
      <div class="health-button red large_size" style="display: inline-block;">
        <span class="glare red large"></span>
      </div>
    <% elsif @stats_hash["routing"]["short_vnodes"].chomp !="0" %>
      <div class="health-button yellow large_size" style="display: inline-block;">
        <span class="glare large"></span>
      </div>
    <% else %>
      <div class="health-button green large_size" style="display: inline-block;">
        <span class="glare large"></span>
      </div>
    <% end %>

    <button class="btn btn-warning" data-toggle="modal" data-target="#recoverModal" <%= get_button_option("recover", @stats_hash, @routing_info)%>>
      Recover
    </button>
  </h2>

  <% if short_vnodes?(@stats_hash) %>
    <div class="status-caution">
      <span id="short-vnodes-caution"><i class="icon-warning-sign"></i></span>
      ROMA have short vnodes. You can solve by executing "Recover" button.
    </div>
  <% end %>

  <% if lost_vnodes?(@stats_hash) %>
    <div class="status-caution">
      <span id="lost-vnodes-caution"><i class="icon-warning-sign"></i></span>
      ROMA have lost vnodes. If you want to repair this, you should rollback routing file directly.
    </div>
  <% end %>

  <% if released_flg?(@routing_info) %>
    <div class="status-caution">
      <span id="lost-vnodes-caution"><i class="icon-warning-sign"></i></span>
      You have to rbalse after finising release process.
    </div>
  <% end %>

  <% if flash[:error_message] %>
    <div class="status-caution">
      <span id="lost-vnodes-caution"><i class="icon-warning-sign"></i></span>
      <%= flash[:error_message] %>
    </div>
  <% end %>

  <% if flash[:unknown] %>
    <div class="status-caution">
      <span class="unknown-icon"><i class="icon-question-sign"></i></span>
      No response from <%= flash[:unknown] %>. Did you execute rbalse just now?<br>
      &ensp;&ensp;&thinsp;In this case, please reload page after few seconds.
    </div>
  <% end %>

  <div class="basic-columns"> 
    <table class="status-panel">
      <tr>
        <td class="panel-instance">
          instance count
          <div class="panel-value">
            <%= @stats_hash["routing"]["nodes.length"] %><br>
              <div class="error-instance-small">
                <% @inactive_routing_list.each{|instance| %><li> <%= instance %> is down</li><% } %>
              </div>
          </div>
        </td>
        <td class="panel-server">
          server count
          <div class="panel-value">
            <%= get_active_server_list.size %>
          </div>
        </td>
        <td class="panel-roma-version">
          ROMA version
          <div class="panel-value">
            <%= @stats_hash["others"]["version"] %>
            <div class ="error-instance-small">
              <% @routing_info.each do |instance, info| %>
                <% if chk_main_version(info["version"]) %>
                  <li class="version-diff-info"><%= "#{instance} using #{info["version"]}" %></li>
                <% end %>
              <% end %>
            </div>
          </div>
        </td>
      </tr>
    
      <tr>
        <% if short_vnodes?(@stats_hash) %>
          <td class="panel-short-vnodes-error">
            short vnodes
            <div class="panel-value">
              <span id="short-vnodes-cnt">
                <%= @stats_hash["routing"]["short_vnodes"] %>
              </span>
              <span id="short-vnodes-alert"><i class="icon-warning-sign"></i></span>
            </div>
          </td>
        <% else %>
          <td class="panel-short-vnodes">
            short vnodes
            <div class="panel-value">
              <%= @stats_hash["routing"]["short_vnodes"] %>
            </div>
          </td>
        <% end %>
    
        <% if @stats_hash["routing"]["lost_vnodes"].chomp == "0" %>
          <td class="panel-lost-vnodes">
            lost vnodes
            <div class="panel-value">
              <span class="panel-value"><%= @stats_hash["routing"]["lost_vnodes"] %></span>
            </div>
          </td>
        <% else %>
          <td class="panel-lost-vnodes" id="lost-vnodes-exist">
            lost vnodes
            <div class="panel-value">
              <span id="lost-vnodes-char" ><%= @stats_hash["routing"]["lost_vnodes"] %></span>
              <span id="lost-vnodes-alert"><i class="icon-warning-sign"></i></span>
            </div>
          </td>
        <% end %>
            
        <td class="panel-gladiator-version">
          Gladiator version
          <div class="panel-value">
            <%= Constants::VERSION %>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <% if ex_process = extra_process_chk(@routing_info)
    case ex_process %>
    <% when "recover" %>
      <div class="extra-process" id="extra-process-recover">
    <% when "release" %>
      <div class="extra-process" id="extra-process-release">
    <% when "join" %>
      <div class="extra-process" id="extra-process-join">
    <% end %>

      <h3><U>Executing process</U></h3>
      <div class="extra-pbar">
        <p><%= ex_process %> is being executed</p>

        <div class="progress progress-striped active">
          <div id="extra-progress-bar" class="progress-bar progress-bar-success"  role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
            <span id="extra-bar-rate">[ToDO]% Complete</span>
          </div>
        </div>

      </div>
    </div>
  <% end %>

</div>

<div class="instances-information">
  <button class="reset-filter btn btn-primary">Reset Filter</button>
  <div class="instance-table">
    <table class="table table-bordered result-table tablesorter cluster-table">
      <thead>

        <tr>
          <th rowspan="2">No.</th>
          <th rowspan="2">Cluster Name</th>
          <th rowspan="2" data-placeholder="">Status</th>
          <th rowspan="2">Data rate</th>
          <th rowspan="2" class="datasize-column">Data size</th>
          <th colspan="2">vnodes count</th>
          <% if session[:user_type] == 'root' %>
            <th rowspan="2" class="button-column">&nbsp;</th>
          <% end %>
        </tr>
        <tr>
          <th class="vnodes-column">Primary</th>
          <th class="vnodes-column">Secondary</th>
        </tr>
      </thead>
      <tbody class="table-contents">
        <% 
        #[ToDO] why not use with_idx?
        index = 0
        @routing_info.each do |(instance, info)|
          if info["status"] == "active" %>
            <tr>
          <% elsif info["status"] =~ /inactive|unknown/ %>
            <tr class="active">
          <% elsif info["status"] =~ /recover|join|release/ %>
            <tr class="warning">
          <% end %>
            <!-- instance No. -->
            <td><%= index += 1 %></td>

            <!-- instance name -->
            <td style="text-align: left"><%= instance %></td>

            <!-- instance status -->
            <td class="instance-status-column" nowrap> 
              <% if info["status"] == "active" %>
                <div class="health-button green small_size" style="display: inline-block;"></div>
                <%= info["status"] %>
              <% elsif info["status"] == "inactive" %>
                <div class="health-button grey small_size" style="display: inline-block;"></div>
                <%= info["status"] %>
              <% elsif info["status"] == "unknown" %>
                <span class="unknown-icon"><i class="icon-question-sign"></i></span>
                <%= info["status"] %>
              <% else %>
                <div class="health-button yellow small_size" style="display: inline-block;"></div>
                <%= info["status"] %>
              <% end %>
            </td>

            <!-- Data rate -->
            <td class="progress-bar-column">
              <% if is_active?(info["status"]) %>
                <div class="progress progress-striped active" >
                  <span class="progress-bar"  role="progressbar" aria-valuenow="<%= current_size_rate(info["size"]) %>" aria-valuemin="0" aria-valuemax="100" style="width: <%= current_size_rate(info["size"]) %>%">
                     <% if current_size_rate(info["size"]) >= 25.0 %>
                       <%= current_size_rate(info["size"]) %> %
                     <% end %>
                  </span>
                  <% if current_size_rate(info["size"]) < 25.0 %>
                    (<%= current_size_rate(info["size"]) %> %)
                  <% end %>
                </div>
              <% end %>
            </td>

            <!-- Data size -->
            <td nowrap>
              <%if is_active?(info["status"]) %><%= instance_size(info["size"]) %> MB<% end %>
            </td>

            <!-- vnodes count -->
            <% instance_name = instance.gsub(/[^0-9]/,"") %>
            <!-- Primary nodes -->
            <td>
              <span id="primary-nodes-<%= instance.gsub(/[^0-9]/,"") %>">
                <%= info["primary_nodes"] %>
              </span>
            </td>
            <!-- Secondary nodes-->
            <td>
              <span id="secondary-nodes-<%= instance.gsub(/[^0-9]/,"") %>">
                <%= info["secondary_nodes"] %>
              </span>
            </td>

            <!-- release/rbalse button(for root user) -->
            <% if session[:user_type] == 'root' %>
              <td class="button-column" nowrap>
                <% if is_active?(info["status"]) %>
                  <!-- Release button -->
                  <button class="btn btn-info" name=<%= instance %> data-toggle="modal" data-target="#release-modal" <%= get_button_option("release", @stats_hash, @routing_info, instance)%>>
                    Release
                  </button>

                  <!-- rbalse button -->
                  <button class="btn btn-warning" name=<%= instance %> data-toggle="modal" data-target="#rbalse-modal" <%= get_button_option("rbalse", nil, @routing_info, instance)%>>
                    rbalse
                  </button>
                <% end %>
              </td>
            <% end %>
          <tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="join-command-generate">
  <dt>
    <div class="join-command-title">
      <h3><U>Join Command Generater</U></h3>
    </div>
  </dt>
    
  <dd>
    <div class="parameter-area">
      <div>
        <%= text_field_tag :new_host, nil, {:placeholder=>"New instance's host.", :id=>"newHost", :size=>"25"} %>
        :new instance's IP address(or Host name).
        <div class="newHost"></div>
      </div>
      <div>
        <%= text_field_tag :new_port, nil, {:placeholder=>"New instance's Port No.", :id=>"newPort", :size=>"25"} %>
        :new instance's port No.
        <div class="newPort"></div>
      </div>
      <div>
        <%= text_field_tag :config_path, @stats_hash['stats']['config_path'], {:placeholder=>"config file's path", :id=>"configPath", :size=>"50"} %>
        :new instance's "config.rb"'s PATH.
        <div class="configPath"></div>
      </div>
      <div>
        <%= check_box :repetition, nil, {:id=>'repetitionCheck'}, checked_value = "a", unchecked_value = "b" %>
        : Use "--enabled_repeathost" option? (Do you wanna boot all instance on single server?)
      </div>

      <%= hidden_field_tag :current_host, ConfigGui::HOST, {:id=>"currentHost"} %>
      <%= hidden_field_tag :current_port,  ConfigGui::PORT, {:id=>"currentPort"} %>
      <%= submit_tag " Generate ", { :class => "btn join-generate-btn allow_submit" }%>
  
      <div class="join-explanation"></div>
      <div class="join-command"></div>
    </div>
  </dd>
</div>
